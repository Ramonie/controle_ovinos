<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Leil√£o de Ovinos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; overflow: hidden; }
        .btn-custom { border-radius: 20px; }
        .search-bar { border-radius: 25px; padding: 10px 20px; }
        .card-img-top { height: 200px; object-fit: cover; }
    </style>
</head>
<body>
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-success">Leil√£o de Ovinos</h1>
        <p class="text-muted">Confira os ovinos dispon√≠veis e d√™ seu lance!</p>
    </div>

    <div class="row justify-content-center mb-4">
        <div class="col-md-6 text-center">
            <form method="get" class="d-flex mb-3">
                <input type="text" name="q" class="form-control search-bar me-2"
                       placeholder="Buscar por brinco ou ra√ßa..." value="{{ request.GET.q }}">
                <button type="submit" class="btn btn-success btn-custom">Buscar</button>
            </form>

            
            <a href="{% url 'home' %}" class="btn btn-warning rounded-pill mb-2">üè† P√°gina Inicial</a>

            {% if user.is_superuser %}
            <a href="{% url 'cadastrar_lote' %}" class="btn btn-primary rounded-pill mb-2">‚ûï Cadastrar Novo Lote</a>
            <button class="btn btn-danger rounded-pill mb-2" data-bs-toggle="modal" data-bs-target="#encerrarModal">
                üö´ Encerrar Leil√£o
            </button>
            {% endif %}
        </div>
    </div>

    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    {% if lotes %}
        <div class="row">
            {% for lote in lotes %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        {% if lote.foto %}
                            <img src="{{ lote.foto.url }}" class="card-img-top" alt="Foto do Ovino">
                        {% else %}
                            <img src="https://via.placeholder.com/400x300?text=Sem+Foto"
                                 class="card-img-top" alt="Sem Foto">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ lote.numero_lote }}</h5>
                            <p class="card-text">{{ lote.descricao|truncatewords:20 }}</p>
                            <p><strong>Data:</strong> {{ lote.data_leilao }}</p>
                            <p><strong>Valor Inicial:</strong> R$ {{ lote.preco_inicial }}</p>

                            <p id="ultimo-lance-{{ lote.id }}">
                                {% if lote.lances.last %}
                                    <strong>√öltimo Lance:</strong>
                                    R$ {{ lote.lances.last.valor }}
                                    ({{ lote.lances.last.usuario.username }})
                                {% else %}
                                    <strong>Sem lances ainda</strong>
                                {% endif %}
                            </p>

                            <a href="{% url 'dar_lance' lote.id %}" class="btn btn-primary">Dar Lance</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning">Nenhum lote cadastrado ainda.</div>
    {% endif %}
</div>

<!-- Modal Encerrar -->
<div class="modal fade" id="encerrarModal" tabindex="-1" aria-labelledby="encerrarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title" id="encerrarModalLabel">Encerrar Lote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <form method="post" action="{% url 'encerrar_leilao' %}">
        {% csrf_token %}
        <div class="modal-body">
          <label for="numero_lote" class="form-label">Digite o n√∫mero do lote para encerrar:</label>
          <input type="text" name="numero_lote" id="numero_lote" class="form-control"
                 placeholder="Ex: Lote 12" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Encerrar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    // Atualiza os lances automaticamente
    setInterval(() => {
        {% for lote in lotes %}
        fetch(`/atualizar_lance/{{ lote.id }}/`)
            .then(response => response.json())
            .then(data => {
                const elemento = document.getElementById("ultimo-lance-{{ lote.id }}");
                if (data.ultimo_lance) {
                    elemento.innerHTML = `<strong>√öltimo Lance:</strong> R$ ${data.ultimo_lance.toFixed(2)} (${data.usuario})`;
                } else {
                    elemento.innerHTML = `<strong>Sem lances ainda</strong>`;
                }
            });
        {% endfor %}
    }, 5000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
